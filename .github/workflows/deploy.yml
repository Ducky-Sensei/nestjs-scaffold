# Deploy Workflow - Runs on merge to master/main
# Builds and deploys both API and Web applications
name: Deploy

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Detect what changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
            web:
              - 'apps/web/**'
              - 'packages/**'

  # Build and deploy API
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api == 'true'
    environment: production-api
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm --filter @scaffold/api test

      - name: Build API
        run: pnpm --filter @scaffold/api build

      # Optional: Build and push Docker image
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3
      #
      # - name: Log in to Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      #
      # - name: Build and push API Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: ./apps/api
      #     push: true
      #     tags: ghcr.io/${{ github.repository }}/api:latest,ghcr.io/${{ github.repository }}/api:${{ github.sha }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # Add your deployment steps here
      # Examples:
      # - Deploy to Heroku
      # - Deploy to Railway
      # - Deploy to AWS ECS
      # - Deploy to Kubernetes

      - name: Notify deployment status
        if: always()
        run: |
          echo "API deployment completed with status: ${{ job.status }}"
          # Add Slack/Discord notification here if needed

  # Build and deploy Web
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true'
    environment: production-web
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm --filter @scaffold/web test

      - name: Build Web
        run: pnpm --filter @scaffold/web build
        env:
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_SENTRY_ENABLED: ${{ secrets.VITE_SENTRY_ENABLED }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_DATADOG_ENABLED: ${{ secrets.VITE_DATADOG_ENABLED }}
          VITE_DATADOG_APPLICATION_ID: ${{ secrets.VITE_DATADOG_APPLICATION_ID }}
          VITE_DATADOG_CLIENT_TOKEN: ${{ secrets.VITE_DATADOG_CLIENT_TOKEN }}

      - name: Create Sentry release
        if: env.VITE_SENTRY_ENABLED == 'true'
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ github.sha }}

      # Example deployment to Vercel (uncomment and configure as needed)
      # - name: Deploy to Vercel
      #   uses: amondnet/vercel-action@v25
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      #     vercel-args: '--prod'
      #     working-directory: apps/web

      # Example deployment to Netlify (uncomment and configure as needed)
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v3.0
      #   with:
      #     publish-dir: './apps/web/dist'
      #     production-branch: master
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Notify deployment status
        if: always()
        run: |
          echo "Web deployment completed with status: ${{ job.status }}"
          # Add Slack/Discord notification here if needed
